<%=  render 'second_menu'%>
<div class="search">
  <%= form_for :staff ,:url=>"/stores/#{params[:store_id]}/market_manages/search_gross_profit", :method => :post, :html => {:remote => true, 'data-type' => 'script'} do %>
    <div><label>时间：</label><input class="Wdate" readonly id="o_gross_started" name="o_started" type="text" onclick="WdatePicker()" />&nbsp;到&nbsp;
      <input class="Wdate" readonly id="o_gross_ended" name="o_ended" type="text" onclick="WdatePicker()"/></div>
    <div><label>产品/服务类型：</label>
      <select id="prod_types" name="prod_types">
        <option value="-1">全部</option>
        <% Product::PRODUCT_TYPES.each do |k, v| %>
          <option value="<%= k %>"><%= v %></option>
        <% end %>
      </select>
    </div>
    <input type="hidden" name="store_id" id="store_id" value="<%= params[:store_id] %>" />
    <div><button type="submit" class="search_btn">查询</button></div>
  <% end %>
</div>

<div class="clear"></div>

<div class="data_body" id="search_gross_profit">
  <div>
    <% unless @orders.blank? %>
      <table width="100%" border="0" cellspacing="0" cellpadding="0" class="data_table">
        <thead>
          <tr class="hbg">
            <td>日期</td>
            <td>相关订单</td>
            <td>成本价</td>
            <td>零售价</td>
            <td>毛利</td>
          </tr>
        </thead>
        <tbody>
          <% @orders.each do |order| %>
          <%
          unless order.c_pcard_relations.blank?
             pp_price = order.c_pcard_relations.map{|cpr| cpr.package_card}.compact.map{|pc| pc.pcard_prod_relations.map{|ppr| ppr.product}.inject(0){|sum,opr| sum += opr.t_price.to_f}}.inject(0){|sum,pc| sum += pc}
          end
            sum = order.order_prod_relations.inject(0){|sum,opr| sum+=(opr.t_price.to_f)*opr.pro_num}
            order_cost_price = sum + pp_price.to_f
          %>
            <tr>
              <td><%= order.created_at.strftime("%Y-%m-%d") if order.created_at %></td>
              <td>
              <%= link_to "#{order.code}", "/orders/#{order.id}/order_info" ,
            :remote => "true", "data-type" => "script", :class => "other_a" %></td>
              <td><%= format("%.2f",order_cost_price) %></td>
              <td><%= format("%.2f",order.price) %></td>
              <td><%= format("%.2f",(order.price.to_f - order_cost_price.to_f) > 0 ? (order.price.to_f - order_cost_price.to_f) : 0) %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <div class="pageTurn">
        <%= will_paginate @orders,:class=>"pageTurn",:previous_label=>"上一页",:next_label=>"下一页" %>
      </div>
    <%else%>
      暂无记录
    <%end%>
  </div>
</div>
<div id="related_order_div"></div>